// –ú—É–ª—å—Ç–∏-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–Ω–∞—è AI —Å–∏—Å—Ç–µ–º–∞ —Å fallback
// –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: Gemini, –ª–æ–∫–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É

const GEMINI_API_KEY = 'AIzaSyCIhH-3VKldhugzLWxf4UWQ6tCrcksrjdA';

// –ü–æ–ª–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ AI
export const UNIVERSITIES_CONTEXT = `
–ë–ê–ó–ê –î–ê–ù–ù–´–• –£–ù–ò–í–ï–†–°–ò–¢–ï–¢–û–í –ö–ê–ó–ê–•–°–¢–ê–ù–ê:

1. NAZARBAYEV UNIVERSITY (NU)
   - –ì–æ—Ä–æ–¥: –ê—Å—Ç–∞–Ω–∞
   - –†–µ–π—Ç–∏–Ω–≥: 4.9/5.0, –ú–∏—Ä–æ–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥: 295 (QS)
   - –¢–∏–ø: –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç
   - –û—Å–Ω–æ–≤–∞–Ω: 2010
   - –°—Ç—É–¥–µ–Ω—Ç–æ–≤: 6,000
   - –°—Ç–æ–∏–º–æ—Å—Ç—å: $7,000 - $9,000 USD/–≥–æ–¥
   - –Ø–∑—ã–∫: 100% –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ü–µ—Ä–≤—ã–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. –í—Ö–æ–¥–∏—Ç –≤ —Ç–æ–ø-300 –º–∏—Ä–æ–≤—ã—Ö —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ THE –∏ QS. –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å Cambridge, Stanford, MIT, NUS.
   - –ü—Ä–æ–≥—Ä–∞–º–º—ã: Computer Science, Engineering, Business, Medicine, Law
   - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: ‚Ññ1 –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ, 98% —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
   - –°–∞–π—Ç: https://nu.edu.kz

2. –ö–ê–ó–ù–£ –∏–º. –∞–ª—å-–§–∞—Ä–∞–±–∏ (KazNU)
   - –ì–æ—Ä–æ–¥: –ê–ª–º–∞—Ç—ã
   - –†–µ–π—Ç–∏–Ω–≥: 4.7/5.0, –ú–∏—Ä–æ–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥: 165 (QS)
   - –¢–∏–ø: –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π
   - –û—Å–Ω–æ–≤–∞–Ω: 1934
   - –°—Ç—É–¥–µ–Ω—Ç–æ–≤: 20,000+
   - –°—Ç–æ–∏–º–æ—Å—Ç—å: 600,000 - 1,800,000 ‚Ç∏/–≥–æ–¥
   - –û–ø–∏—Å–∞–Ω–∏–µ: –°—Ç–∞—Ä–µ–π—à–∏–π –∏ –∫—Ä—É–ø–Ω–µ–π—à–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. 17 —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–æ–≤, 200+ –ø—Ä–æ–≥—Ä–∞–º–º. 1000+ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤.
   - –ü—Ä–æ–≥—Ä–∞–º–º—ã: IT, –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –§–∏–∑–∏–∫–∞, –•–∏–º–∏—è, –≠–∫–æ–Ω–æ–º–∏–∫–∞, –ü—Ä–∞–≤–æ, –ñ—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∞
   - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: 165 –º–µ—Å—Ç–æ QS, 90% —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
   - –°–∞–π—Ç: https://kaznu.kz

3. ASTANA IT UNIVERSITY (AITU)
   - –ì–æ—Ä–æ–¥: –ê—Å—Ç–∞–Ω–∞
   - –†–µ–π—Ç–∏–Ω–≥: 4.6/5.0
   - –¢–∏–ø: –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π IT-—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç
   - –û—Å–Ω–æ–≤–∞–Ω: 2017
   - –°—Ç—É–¥–µ–Ω—Ç–æ–≤: 3,500
   - –°—Ç–æ–∏–º–æ—Å—Ç—å: 1,800,000 - 2,200,000 ‚Ç∏/–≥–æ–¥
   - –û–ø–∏—Å–∞–Ω–∏–µ: –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π IT-—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç. –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å Google, Microsoft, AWS. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ AI –∏ Data Science.
   - –ü—Ä–æ–≥—Ä–∞–º–º—ã: AI, Data Science, Cybersecurity, Software Engineering, Big Data
   - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: –¢–æ–ø IT-–≤—É–∑ –†–ö, 99% —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
   - –°–∞–π—Ç: https://aitu.edu.kz

4. –ö–ê–ó–ê–•–°–¢–ê–ù–°–ö–û-–ë–†–ò–¢–ê–ù–°–ö–ò–ô –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –£–ù–ò–í–ï–†–°–ò–¢–ï–¢ (–ö–ë–¢–£)
   - –ì–æ—Ä–æ–¥: –ê–ª–º–∞—Ç—ã
   - –†–µ–π—Ç–∏–Ω–≥: 4.5/5.0, –ú–∏—Ä–æ–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥: 401-450 (QS)
   - –¢–∏–ø: –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π
   - –û—Å–Ω–æ–≤–∞–Ω: 2001
   - –°—Ç—É–¥–µ–Ω—Ç–æ–≤: 5,500
   - –°—Ç–æ–∏–º–æ—Å—Ç—å: 1,500,000 - 2,500,000 ‚Ç∏/–≥–æ–¥
   - –û–ø–∏—Å–∞–Ω–∏–µ: –í–µ–¥—É—â–∏–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç —Å –±—Ä–∏—Ç–∞–Ω—Å–∫–∏–º–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏. –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å Heriot-Watt University.
   - –ü—Ä–æ–≥—Ä–∞–º–º—ã: Petroleum Engineering, IT, Economics, Geology, Chemical Engineering
   - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: –î–≤–æ–π–Ω—ã–µ –¥–∏–ø–ª–æ–º—ã UK, ABET –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è, 95% —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
   - –°–∞–π—Ç: https://kbtu.edu.kz

5. KIMEP UNIVERSITY
   - –ì–æ—Ä–æ–¥: –ê–ª–º–∞—Ç—ã
   - –†–µ–π—Ç–∏–Ω–≥: 4.6/5.0
   - –¢–∏–ø: –ß–∞—Å—Ç–Ω—ã–π
   - –û—Å–Ω–æ–≤–∞–Ω: 1992
   - –°—Ç—É–¥–µ–Ω—Ç–æ–≤: 4,500
   - –°—Ç–æ–∏–º–æ—Å—Ç—å: 2,200,000 - 3,500,000 ‚Ç∏/–≥–æ–¥
   - –û–ø–∏—Å–∞–Ω–∏–µ: –õ—É—á—à–∞—è –±–∏–∑–Ω–µ—Å-—à–∫–æ–ª–∞ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ê–∑–∏–∏. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—É–∑ –≤ –¶–ê —Å –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏–µ–π AACSB. 100% –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.
   - –ü—Ä–æ–≥—Ä–∞–º–º—ã: Business Administration, Finance, Marketing, Law, Media
   - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: AACSB –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è, 100+ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –≤ –º–∏—Ä–µ
   - –°–∞–π—Ç: https://kimep.kz

6. SULEYMAN DEMIREL UNIVERSITY (SDU)
   - –ì–æ—Ä–æ–¥: –ê–ª–º–∞—Ç—ã
   - –†–µ–π—Ç–∏–Ω–≥: 4.4/5.0
   - –¢–∏–ø: –ß–∞—Å—Ç–Ω—ã–π
   - –û—Å–Ω–æ–≤–∞–Ω: 1996
   - –°—Ç—É–¥–µ–Ω—Ç–æ–≤: 7,000
   - –°—Ç–æ–∏–º–æ—Å—Ç—å: 1,400,000 - 2,800,000 ‚Ç∏/–≥–æ–¥
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç —Å —Ç—É—Ä–µ—Ü–∫–∏–º–∏ —Ç—Ä–∞–¥–∏—Ü–∏—è–º–∏. –°–∏–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ –º–µ–¥–∏—Ü–∏–Ω–µ –∏ –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏.
   - –ü—Ä–æ–≥—Ä–∞–º–º—ã: Medicine, Engineering, Philology, Economics, Law
   - –°–∞–π—Ç: https://sdu.edu.kz

7. –ú–£–ò–¢ (IITU)
   - –ì–æ—Ä–æ–¥: –ê–ª–º–∞—Ç—ã
   - –†–µ–π—Ç–∏–Ω–≥: 4.4/5.0
   - –¢–∏–ø: –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π
   - –û—Å–Ω–æ–≤–∞–Ω: 2009
   - –°—Ç—É–¥–µ–Ω—Ç–æ–≤: 2,500
   - –°—Ç–æ–∏–º–æ—Å—Ç—å: 1,600,000 - 2,000,000 ‚Ç∏/–≥–æ–¥
   - –û–ø–∏—Å–∞–Ω–∏–µ: –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π IT-—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç. –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å Kaspersky, EPAM, Yandex.
   - –ü—Ä–æ–≥—Ä–∞–º–º—ã: Software Engineering, Data Science, Cybersecurity, AI
   - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: –¢–æ–ø-3 IT –≤—É–∑ –†–ö, 98% –≤ IT-–∏–Ω–¥—É—Å—Ç—Ä–∏–∏
   - –°–∞–π—Ç: https://iitu.edu.kz

8. –ï–ù–£ –∏–º. –õ.–ù. –ì—É–º–∏–ª–µ–≤–∞
   - –ì–æ—Ä–æ–¥: –ê—Å—Ç–∞–Ω–∞
   - –†–µ–π—Ç–∏–Ω–≥: 4.5/5.0, –ú–∏—Ä–æ–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥: 501-550 (QS)
   - –¢–∏–ø: –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π
   - –û—Å–Ω–æ–≤–∞–Ω: 1996
   - –°—Ç—É–¥–µ–Ω—Ç–æ–≤: 16,000
   - –°—Ç–æ–∏–º–æ—Å—Ç—å: 550,000 - 1,200,000 ‚Ç∏/–≥–æ–¥
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ö—Ä—É–ø–Ω–µ–π—à–∏–π –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç —Å—Ç–æ–ª–∏—Ü—ã. 80+ –ø—Ä–æ–≥—Ä–∞–º–º –æ–±—É—á–µ–Ω–∏—è.
   - –ü—Ä–æ–≥—Ä–∞–º–º—ã: –§–∏–ª–æ–ª–æ–≥–∏—è, –ò—Å—Ç–æ—Ä–∏—è, –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –≠–∫–æ–Ω–æ–º–∏–∫–∞, –ü—Ä–∞–≤–æ
   - –°–∞–π—Ç: https://enu.kz
`;

// Gemini API
async function callGemini(prompt: string): Promise<string | null> {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 1024
          }
        })
      }
    );

    if (!response.ok) {
      console.error('Gemini API error:', response.status);
      return null;
    }

    const data = await response.json();
    
    if (data.promptFeedback?.blockReason) {
      console.warn('Content blocked:', data.promptFeedback.blockReason);
      return null;
    }

    return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
  } catch (error) {
    console.error('Gemini error:', error);
    return null;
  }
}

// –£–º–Ω–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
function getLocalResponse(message: string): string {
  const lower = message.toLowerCase();

  // IT –ø—Ä–æ–≥—Ä–∞–º–º—ã
  if (lower.includes('it') || lower.includes('–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ') || lower.includes('–∫–æ–º–ø—å—é—Ç–µ—Ä')) {
    return `üíª **–õ—É—á—à–∏–µ IT-—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞:**

1. **AITU** (Astana IT University) - –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π IT-–≤—É–∑
   üìç –ê—Å—Ç–∞–Ω–∞ | ‚≠ê 4.6/5.0 | üí∞ 1.8-2.2M‚Ç∏/–≥–æ–¥
   üéì AI, Data Science, Cybersecurity, Software Engineering
   ‚úÖ –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å Google, Microsoft, AWS
   ‚úÖ 99% —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

2. **Nazarbayev University** - –ú–∏—Ä–æ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å
   üìç –ê—Å—Ç–∞–Ω–∞ | ‚≠ê 4.9/5.0 | üí∞ $7-9K/–≥–æ–¥
   üéì Computer Science, Engineering
   ‚úÖ –¢–æ–ø-300 –º–∏—Ä–æ–≤—ã—Ö —Ä–µ–π—Ç–∏–Ω–≥–æ–≤

3. **–ú–£–ò–¢** (IITU) - IT-—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
   üìç –ê–ª–º–∞—Ç—ã | ‚≠ê 4.4/5.0 | üí∞ 1.6-2M‚Ç∏/–≥–æ–¥
   üéì Software Engineering, Data Science, AI
   ‚úÖ –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å Kaspersky, EPAM

4. **–ö–ë–¢–£** - –ò–Ω–∂–µ–Ω–µ—Ä–∏—è –∏ IT
   üìç –ê–ª–º–∞—Ç—ã | ‚≠ê 4.5/5.0 | üí∞ 1.5-2.5M‚Ç∏/–≥–æ–¥
   üéì IT, Engineering
   ‚úÖ –ë—Ä–∏—Ç–∞–Ω—Å–∫–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã

üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–ª—è IT-—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π –ª—É—á—à–∏–π –≤—ã–±–æ—Ä - AITU –∏–ª–∏ NU!`;
  }

  // –ë–∏–∑–Ω–µ—Å
  if (lower.includes('–±–∏–∑–Ω–µ—Å') || lower.includes('—ç–∫–æ–Ω–æ–º–∏–∫–∞') || lower.includes('—Ñ–∏–Ω–∞–Ω—Å')) {
    return `üíº **–õ—É—á—à–∏–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ–≥—Ä–∞–º–º—ã:**

1. **KIMEP University** - –õ—É—á—à–∞—è –±–∏–∑–Ω–µ—Å-—à–∫–æ–ª–∞ –¶–ê
   üìç –ê–ª–º–∞—Ç—ã | ‚≠ê 4.6/5.0 | üí∞ 2.2-3.5M‚Ç∏/–≥–æ–¥
   ‚úÖ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è AACSB –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è –≤ –¶–ê
   ‚úÖ 100% –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ

2. **NU Graduate School of Business**
   üìç –ê—Å—Ç–∞–Ω–∞ | ‚≠ê 4.9/5.0 | üí∞ $7-9K/–≥–æ–¥
   ‚úÖ –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
   ‚úÖ –ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ —Å —Ç–æ–ø –±–∏–∑–Ω–µ—Å-—à–∫–æ–ª–∞–º–∏

3. **–ö–ë–¢–£** - –≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ –±–∏–∑–Ω–µ—Å
   üìç –ê–ª–º–∞—Ç—ã | ‚≠ê 4.5/5.0 | üí∞ 1.5-2.5M‚Ç∏/–≥–æ–¥
   ‚úÖ –ë—Ä–∏—Ç–∞–Ω—Å–∫–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã

üí° **–°–æ–≤–µ—Ç:** KIMEP - –∑–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –±–∏–∑–Ω–µ—Å-–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–≥–∏–æ–Ω–µ!`;
  }

  // –ì—Ä–∞–Ω—Ç—ã
  if (lower.includes('–≥—Ä–∞–Ω—Ç') || lower.includes('—Å—Ç–∏–ø–µ–Ω–¥–∏') || lower.includes('–±–µ—Å–ø–ª–∞—Ç–Ω–æ')) {
    return `üéì **–ì—Ä–∞–Ω—Ç—ã –∏ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏:**

üìã **–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥—Ä–∞–Ω—Ç—ã:**
‚Ä¢ –ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ï–ù–¢
‚Ä¢ –ü–æ–∫—Ä—ã–≤–∞—é—Ç 100% —Å—Ç–æ–∏–º–æ—Å—Ç–∏
‚Ä¢ –ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: 110-130

üèõÔ∏è **–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—Å–∫–∏–µ –≥—Ä–∞–Ω—Ç—ã:**
‚Ä¢ NU - –ø–æ–ª–Ω—ã–µ –≥—Ä–∞–Ω—Ç—ã –¥–ª—è —Ç–æ–ø-–∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤
‚Ä¢ AITU - –≥—Ä–∞–Ω—Ç—ã –¥–æ 100% –¥–ª—è IT-—Ç–∞–ª–∞–Ω—Ç–æ–≤
‚Ä¢ KIMEP - —Å—Ç–∏–ø–µ–Ω–¥–∏–∏ –¥–æ 50%

üí∞ **–°—Ç–∏–ø–µ–Ω–¥–∏–∏:**
‚Ä¢ –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è: 36,000‚Ç∏/–º–µ—Å
‚Ä¢ NU: –¥–æ 100,000‚Ç∏/–º–µ—Å
‚Ä¢ –ó–∞ –æ—Ç–ª–∏—á–Ω—É—é —É—á–µ–±—É: +20-50%

üí° **–°–æ–≤–µ—Ç:** –ù–∞–±–∏—Ä–∞–π—Ç–µ 120+ –±–∞–ª–ª–æ–≤ –ï–ù–¢!`;
  }

  // –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ
  if (lower.includes('–ø–æ—Å—Ç—É–ø') || lower.includes('–¥–æ–∫—É–º–µ–Ω—Ç') || lower.includes('–µ–Ω—Ç')) {
    return `üìù **–ü—Ä–æ—Ü–µ—Å—Å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è:**

1Ô∏è‚É£ **–°–¥–∞—Ç—å –ï–ù–¢** (–∏—é–Ω—å-–∏—é–ª—å)
   ‚Ä¢ –ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: 50-130
   ‚Ä¢ –î–ª—è –≥—Ä–∞–Ω—Ç–æ–≤: 110+

2Ô∏è‚É£ **–î–æ–∫—É–º–µ–Ω—Ç—ã:**
   ‚Ä¢ –ê—Ç—Ç–µ—Å—Ç–∞—Ç
   ‚Ä¢ –£–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏
   ‚Ä¢ –§–æ—Ç–æ 3x4
   ‚Ä¢ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ï–ù–¢

3Ô∏è‚É£ **–ü–æ–¥–∞—á–∞ –∑–∞—è–≤–ª–µ–Ω–∏—è:**
   ‚Ä¢ –û–Ω–ª–∞–π–Ω –∏–ª–∏ –ª–∏—á–Ω–æ
   ‚Ä¢ –î–µ–¥–ª–∞–π–Ω: 10-20 –∞–≤–≥—É—Å—Ç–∞

4Ô∏è‚É£ **–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ:** –∫–æ–Ω–µ—Ü –∞–≤–≥—É—Å—Ç–∞

üìÖ **–í–∞–∂–Ω—ã–µ –¥–∞—Ç—ã:**
‚Ä¢ –ï–ù–¢: –∏—é–Ω—å-–∏—é–ª—å
‚Ä¢ –ü—Ä–∏–µ–º: 1 –∏—é–ª—è - 20 –∞–≤–≥—É—Å—Ç–∞
‚Ä¢ –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ: 25 –∞–≤–≥—É—Å—Ç–∞`;
  }

  // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
  if (lower.includes('—Å—Ä–∞–≤–Ω') || lower.includes('–ª—É—á—à')) {
    return `üìä **–¢–æ–ø —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞:**

| –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç | –†–µ–π—Ç–∏–Ω–≥ | –ì–æ—Ä–æ–¥ | –°—Ç–æ–∏–º–æ—Å—Ç—å |
|-------------|---------|-------|-----------|
| NU          | 4.9 ‚≠ê  | –ê—Å—Ç–∞–Ω–∞ | $7-9K    |
| –ö–∞–∑–ù–£       | 4.7 ‚≠ê  | –ê–ª–º–∞—Ç—ã | 0.6-1.8M‚Ç∏|
| AITU        | 4.6 ‚≠ê  | –ê—Å—Ç–∞–Ω–∞ | 1.8-2.2M‚Ç∏|
| KIMEP       | 4.6 ‚≠ê  | –ê–ª–º–∞—Ç—ã | 2.2-3.5M‚Ç∏|
| –ö–ë–¢–£        | 4.5 ‚≠ê  | –ê–ª–º–∞—Ç—ã | 1.5-2.5M‚Ç∏|

üéØ **–ü–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º:**
‚Ä¢ IT: AITU, –ú–£–ò–¢, NU
‚Ä¢ –ë–∏–∑–Ω–µ—Å: KIMEP, NU
‚Ä¢ –ò–Ω–∂–µ–Ω–µ—Ä–∏—è: –ö–ë–¢–£, –ö–∞–∑–ù–£
‚Ä¢ –ú–µ–¥–∏—Ü–∏–Ω–∞: SDU, NU`;
  }

  // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
  return `üëã –ü—Ä–∏–≤–µ—Ç! –Ø AI-–ø–æ–º–æ—â–Ω–∏–∫ KZ UniVerse.

üéì –ú–æ–≥—É –ø–æ–º–æ—á—å —Å:
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞—Ö
‚Ä¢ –í—ã–±–æ—Ä–æ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã
‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ–º –≤—É–∑–æ–≤
‚Ä¢ –ì—Ä–∞–Ω—Ç–∞–º–∏ –∏ —Å—Ç–∏–ø–µ–Ω–¥–∏—è–º–∏
‚Ä¢ –ü—Ä–æ—Ü–µ—Å—Å–æ–º –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è

üìù **–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:**
‚Ä¢ "–õ—É—á—à–∏–µ IT —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã"
‚Ä¢ "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≥—Ä–∞–Ω—Ç?"
‚Ä¢ "–°—Ä–∞–≤–Ω–∏ NU –∏ AITU"
‚Ä¢ "–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ KIMEP"

–ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å! üòä`;
}

// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è AI —Å fallback
export async function getAIResponse(message: string, portfolio?: any): Promise<string> {
  const systemPrompt = `–¢—ã AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã KZ UniVerse - –µ–¥–∏–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ.

${UNIVERSITIES_CONTEXT}

${portfolio ? `–ü–û–†–¢–§–û–õ–ò–û –°–¢–£–î–ï–ù–¢–ê:
- –ï–ù–¢: ${portfolio.entScore || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
- GPA: ${portfolio.gpa || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
- IELTS: ${portfolio.ieltsScore || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: ${portfolio.achievements?.length || 0}
- –û–ª–∏–º–ø–∏–∞–¥—ã: ${portfolio.olympiads?.length || 0}
` : ''}

–í–û–ü–†–û–°: ${message}

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –ò—Å–ø–æ–ª—å–∑—É–π –ö–û–ù–ö–†–ï–¢–ù–´–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –≤—ã—à–µ
3. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
4. –î–∞–≤–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å —Ü–∏—Ñ—Ä–∞–º–∏
5. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Å —ç–º–æ–¥–∑–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ
6. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤—É–∑ - –¥–∞–π –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
7. –°—Ä–∞–≤–Ω–∏–≤–∞–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –µ—Å–ª–∏ –ø—Ä–æ—Å—è—Ç

–û–¢–í–ï–¢:`;

  // –ü–æ–ø—ã—Ç–∫–∞ 1: Gemini
  const geminiResponse = await callGemini(systemPrompt);
  if (geminiResponse) {
    return geminiResponse;
  }

  // Fallback: –õ–æ–∫–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
  console.log('Using local fallback response');
  return getLocalResponse(message);
}

// –†–∞—Å—á–µ—Ç —à–∞–Ω—Å–æ–≤ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
export async function calculateAdmissionChance(
  portfolio: any, 
  universityId: string, 
  programId: string
): Promise<{
  chance: number;
  factors: { entScore: number; gpa: number; achievements: number; competition: number };
  recommendations: string[];
}> {
  // –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç
  const minENT = 50;
  const entScore = portfolio?.entScore 
    ? Math.min(100, Math.max(0, (portfolio.entScore / 140) * 100))
    : 0;
  const gpa = portfolio?.gpa 
    ? Math.min(100, Math.max(0, (portfolio.gpa / 5.0) * 100))
    : 0;
  const achievements = Math.min(100, Math.max(0, 
    ((portfolio?.achievements?.length || 0) * 10) + 
    ((portfolio?.olympiads?.length || 0) * 15)
  ));
  
  // –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞
  const competitionMap: { [key: string]: number } = {
    'nu': 95,
    'kaznu': 80,
    'aitu': 85,
    'kbtu': 82,
    'kimep': 78,
    'sdu': 70,
    'iitu': 75,
    'enu': 72
  };
  const competition = competitionMap[universityId] || 70;

  // –†–∞—Å—á–µ—Ç —à–∞–Ω—Å–∞
  const baseChance = (entScore * 0.4 + gpa * 0.25 + achievements * 0.25);
  const competitionPenalty = Math.max(0, (competition - 50) * 0.15);
  const chance = Math.max(5, Math.min(95, baseChance - competitionPenalty));

  // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  const recommendations: string[] = [];
  
  if (!portfolio?.entScore) {
    recommendations.push('–£–∫–∞–∂–∏—Ç–µ –±–∞–ª–ª –ï–ù–¢ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞');
  } else if (portfolio.entScore < 100) {
    recommendations.push('–ü–æ–≤—ã—Å—å—Ç–µ –±–∞–ª–ª –ï–ù–¢ –¥–æ 100+ –¥–ª—è –ª—É—á—à–∏—Ö —à–∞–Ω—Å–æ–≤');
  } else if (portfolio.entScore >= 120) {
    recommendations.push('–û—Ç–ª–∏—á–Ω—ã–π –±–∞–ª–ª –ï–ù–¢! –ü—Ä–µ—Ç–µ–Ω–¥—É–µ—Ç–µ –Ω–∞ –≥—Ä–∞–Ω—Ç');
  }

  if (!portfolio?.gpa) {
    recommendations.push('–£–∫–∞–∂–∏—Ç–µ GPA –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞');
  } else if (portfolio.gpa < 4.0) {
    recommendations.push('–£–ª—É—á—à–∏—Ç–µ —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –¥–æ 4.0+');
  }

  if (!portfolio?.olympiads || portfolio.olympiads.length === 0) {
    recommendations.push('–£—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ –æ–ª–∏–º–ø–∏–∞–¥–∞—Ö –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —à–∞–Ω—Å–æ–≤');
  }

  if (!portfolio?.achievements || portfolio.achievements.length === 0) {
    recommendations.push('–î–æ–±–∞–≤—å—Ç–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ');
  }

  if (chance < 50) {
    recommendations.push('–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã');
  }

  if (recommendations.length === 0) {
    recommendations.push('–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç! –ü–æ–¥–∞–≤–∞–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã');
  }

  return {
    chance: Math.round(chance),
    factors: {
      entScore: Math.round(entScore),
      gpa: Math.round(gpa),
      achievements: Math.round(achievements),
      competition: Math.round(competition)
    },
    recommendations: recommendations.slice(0, 5)
  };
}

