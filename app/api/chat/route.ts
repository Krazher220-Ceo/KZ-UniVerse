import { NextRequest, NextResponse } from 'next/server'
import universitiesData from '@/data/universities.json'
import programsData from '@/data/programs.json'

const GEMINI_API_KEY = 'AIzaSyCIhH-3VKldhugzLWxf4UWQ6tCrcksrjdA'
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent'

export const dynamic = 'force-dynamic'

export async function POST(request: NextRequest) {
  try {
    const { message, history, portfolio } = await request.json()

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Gemini API –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫
    try {
      const geminiResponse = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: buildGeminiPrompt(message, portfolio, universitiesData, programsData)
            }]
          }]
        })
      })

      if (geminiResponse.ok) {
        const data = await geminiResponse.json()
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text
        if (text && text.trim()) {
          return NextResponse.json({ response: text })
        }
      } else {
        const errorText = await geminiResponse.text()
        console.error('Gemini API error response:', errorText)
      }
    } catch (geminiError: any) {
      console.error('Gemini API error:', geminiError?.message || geminiError)
    }

    // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Gemini –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    const response = generateEnhancedResponse(message, history, universitiesData, programsData)
    return NextResponse.json({ response })
  } catch (error) {
    console.error('Chat API error:', error)
    return NextResponse.json(
      { error: 'Failed to process message' },
      { status: 500 }
    )
  }
}

function buildGeminiPrompt(message: string, portfolio: any, universities: any[], programs: any[]): string {
  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  const topUniversities = universities.slice(0, 10).map(u => 
    `- ${u.shortName} (${u.name}): —Ä–µ–π—Ç–∏–Ω–≥ ${u.rating}/5.0, –≥–æ—Ä–æ–¥ ${u.city}, —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ç ${(u.tuitionRange.min / 1000000).toFixed(1)}M‚Ç∏/–≥–æ–¥`
  ).join('\n')

  const topPrograms = programs.slice(0, 10).map(p => 
    `- ${p.nameRu} (${p.field}): ${p.universityId}, —Å—Ç–æ–∏–º–æ—Å—Ç—å ${(p.tuitionPerYear / 1000000).toFixed(1)}M‚Ç∏/–≥–æ–¥`
  ).join('\n')

  return `–¢—ã AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã KZ UniVerse - –µ–¥–∏–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ.

–ö–û–ù–¢–ï–ö–°–¢ –ë–ê–ó–´ –î–ê–ù–ù–´–•:
–í —Å–∏—Å—Ç–µ–º–µ ${universities.length} —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤ –∏ ${programs.length} –ø—Ä–æ–≥—Ä–∞–º–º.

–¢–æ–ø —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã:
${topUniversities}

–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:
${topPrograms}

${portfolio ? `–ü–û–†–¢–§–û–õ–ò–û –°–¢–£–î–ï–ù–¢–ê:
- –ë–∞–ª–ª –ï–ù–¢: ${portfolio.entScore || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
- GPA: ${portfolio.gpa || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
- IELTS: ${portfolio.ieltsScore || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: ${portfolio.achievements?.length || 0}
- –û–ª–∏–º–ø–∏–∞–¥—ã: ${portfolio.olympiads?.length || 0}
` : ''}

–í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: ${message}

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
3. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã
4. –î–∞–≤–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
5. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –æ –Ω–µ–º
6. –ü—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
7. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Å —ç–º–æ–¥–∑–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ

–û–¢–í–ï–¢:`
}

function generateEnhancedResponse(
  message: string, 
  history: any[], 
  universities: any[], 
  programs: any[]
): string {
  const lowerMessage = message.toLowerCase()

  // IT and Computer Science queries
  if (lowerMessage.includes('it') || lowerMessage.includes('–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ') || 
      lowerMessage.includes('–∫–æ–º–ø—å—é—Ç–µ—Ä') || lowerMessage.includes('–∞–π—Ç–∏')) {
    return `üíª **–õ—É—á—à–∏–µ IT-—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞:**

1. **AITU (Astana IT University)**
   ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: AI, Data Science, Cybersecurity
   ‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: 1.8-2.2 –º–ª–Ω‚Ç∏/–≥–æ–¥
   ‚Ä¢ –¢—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: 99%
   ‚Ä¢ –ü–∞—Ä—Ç–Ω–µ—Ä—ã: Google, Microsoft, AWS

2. **Nazarbayev University**
   ‚Ä¢ –ü—Ä–æ–≥—Ä–∞–º–º–∞: Computer Science (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å)
   ‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: 8,000 USD/–≥–æ–¥
   ‚Ä¢ –û–±—É—á–µ–Ω–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
   ‚Ä¢ –¢–æ–ø-300 –≤ –º–∏—Ä–µ

3. **–ú–£–ò–¢**
   ‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: Software Engineering, Data Science
   ‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: 1.6-2.0 –º–ª–Ω‚Ç∏/–≥–æ–¥
   ‚Ä¢ –ü–∞—Ä—Ç–Ω–µ—Ä—ã: Kaspersky, EPAM, Yandex

–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ?`
  }

  // Business and Economics - using database
  if (lowerMessage.includes('–±–∏–∑–Ω–µ—Å') || lowerMessage.includes('—ç–∫–æ–Ω–æ–º–∏–∫–∞') || 
      lowerMessage.includes('–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç')) {
    const businessPrograms = programs.filter(p => p.field === 'Business')
    const businessUniversities = universities.filter(u => 
      businessPrograms.some(p => p.universityId === u.id)
    ).slice(0, 5)

    let response = `üíº **–¢–æ–ø –±–∏–∑–Ω–µ—Å-—à–∫–æ–ª—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞:**\n\n`
    
    businessUniversities.forEach((uni, index) => {
      const uniPrograms = businessPrograms.filter(p => p.universityId === uni.id)
      response += `${index + 1}. **${uni.shortName} (${uni.name})**\n`
      response += `   ‚Ä¢ –ì–æ—Ä–æ–¥: ${uni.city}\n`
      response += `   ‚Ä¢ –†–µ–π—Ç–∏–Ω–≥: ${uni.rating}/5.0\n`
      response += `   ‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${(uni.tuitionRange.min / 1000000).toFixed(1)}-${(uni.tuitionRange.max / 1000000).toFixed(1)} –º–ª–Ω‚Ç∏/–≥–æ–¥\n`
      if (uniPrograms.length > 0) {
        response += `   ‚Ä¢ –ü—Ä–æ–≥—Ä–∞–º–º—ã: ${uniPrograms.map(p => p.nameRu).join(', ')}\n`
      }
      response += `\n`
    })

    response += `–ö–∞–∫–æ–π –±—é–¥–∂–µ—Ç –≤—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ?`
    return response
  }

  // Medicine
  if (lowerMessage.includes('–º–µ–¥–∏—Ü–∏–Ω') || lowerMessage.includes('–≤—Ä–∞—á') || 
      lowerMessage.includes('doctor')) {
    return `‚öïÔ∏è **–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:**

**Suleyman Demirel University (SDU)**
‚Ä¢ General Medicine (5 –ª–µ—Ç)
‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: 2.8 –º–ª–Ω‚Ç∏/–≥–æ–¥
‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∏–º—É–ª—è—Ü–∏–æ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä
‚Ä¢ –û–±—É—á–µ–Ω–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –∏ —Ä—É—Å—Å–∫–æ–º
‚Ä¢ –ü—Ä–∞–∫—Ç–∏–∫–∞ –≤ –ª—É—á—à–∏—Ö –∫–ª–∏–Ω–∏–∫–∞—Ö

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
‚Ä¢ –ï–ù–¢: –º–∏–Ω–∏–º—É–º 125 –±–∞–ª–ª–æ–≤
‚Ä¢ –ü—Ä–µ–¥–º–µ—Ç—ã: –ë–∏–æ–ª–æ–≥–∏—è, –•–∏–º–∏—è, –§–∏–∑–∏–∫–∞
‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ

–¢—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –≤ –†–ö: 98%

–ò–Ω—Ç–µ—Ä–µ—Å—É—é—Ç –¥—Ä—É–≥–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏?`
  }

  // Grants and scholarships
  if (lowerMessage.includes('–≥—Ä–∞–Ω—Ç') || lowerMessage.includes('—Å—Ç–∏–ø–µ–Ω–¥–∏—è') || 
      lowerMessage.includes('scholarship')) {
    return `üéì **–ì—Ä–∞–Ω—Ç—ã –∏ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏:**

**–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –≥—Ä–∞–Ω—Ç –†–ö:**
‚Ä¢ –ü–æ–∫—Ä—ã–≤–∞–µ—Ç 100% —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–±—É—á–µ–Ω–∏—è
‚Ä¢ –î–æ—Å—Ç—É–ø–µ–Ω –≤–æ –≤—Å–µ—Ö –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—É–∑–∞—Ö
‚Ä¢ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: –≤—ã—Å–æ–∫–∏–π –±–∞–ª–ª –ï–ù–¢ (–æ–±—ã—á–Ω–æ 110+)
‚Ä¢ –ö–æ–Ω–∫—É—Ä—Å: 3-5 —á–µ–ª–æ–≤–µ–∫ –Ω–∞ –º–µ—Å—Ç–æ

**–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤:**
‚Ä¢ **NU**: 50-100% —Å–∫–∏–¥–∫–∞ –¥–ª—è –æ—Ç–ª–∏—á–Ω–∏–∫–æ–≤
‚Ä¢ **AITU**: –≥—Ä–∞–Ω—Ç—ã –æ—Ç 30% –¥–æ 100%
‚Ä¢ **–ö–∞–∑–ù–£**: –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏ 36,000-100,000‚Ç∏/–º–µ—Å

**–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –≥—Ä–∞–Ω—Ç—ã:**
‚Ä¢ Bolashak (–ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –∑–∞ —Ä—É–±–µ–∂–æ–º)
‚Ä¢ Al-Farabi Foundation
‚Ä¢ –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –∑–∞—Ä—É–±–µ–∂–Ω—ã–º–∏ –≤—É–∑–∞–º–∏

**–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å:**
1. –•–æ—Ä–æ—à–æ —Å–¥–∞—Ç—å –ï–ù–¢ (120+ –±–∞–ª–ª–æ–≤)
2. –ò–º–µ—Ç—å –≤—ã—Å–æ–∫–∏–π —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –∞—Ç—Ç–µ—Å—Ç–∞—Ç–∞
3. –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –æ–ª–∏–º–ø–∏–∞–¥–∞—Ö (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–∞–ª–ª—ã)
4. –ü–æ–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤–æ–≤—Ä–µ–º—è

–ö–∞–∫–æ–π —É –≤–∞—Å –æ–∂–∏–¥–∞–µ–º—ã–π –±–∞–ª–ª –ï–ù–¢?`
  }

  // Comparison
  if (lowerMessage.includes('—Å—Ä–∞–≤–Ω') || lowerMessage.includes('—Ä–∞–∑–Ω–∏—Ü') || 
      lowerMessage.includes('vs') || lowerMessage.includes('–∏–ª–∏')) {
    return `üìä **–ü–æ–º–æ–≥—É —Å—Ä–∞–≤–Ω–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã!**

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª [–°—Ä–∞–≤–Ω–µ–Ω–∏–µ](/compare) –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

–ò–ª–∏ —Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã —Ö–æ—Ç–∏—Ç–µ —Å—Ä–∞–≤–Ω–∏—Ç—å?
–ù–∞–ø—Ä–∏–º–µ—Ä: "–°—Ä–∞–≤–Ω–∏ NU –∏ AITU" –∏–ª–∏ "–ß—Ç–æ –ª—É—á—à–µ - KIMEP –∏–ª–∏ –ö–∞–∑–ù–£?"

–ú–æ–≥—É —Å—Ä–∞–≤–Ω–∏—Ç—å –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
‚Ä¢ üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è
‚Ä¢ ‚≠ê –†–µ–π—Ç–∏–Ω–≥ –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—è
‚Ä¢ üìö –ü—Ä–æ–≥—Ä–∞–º–º—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
‚Ä¢ üåç –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ
‚Ä¢ üè¢ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
‚Ä¢ üìà –¢—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤`
  }

  // Admission process
  if (lowerMessage.includes('–ø–æ—Å—Ç—É–ø') || lowerMessage.includes('–¥–æ–∫—É–º–µ–Ω—Ç') || 
      lowerMessage.includes('–∫–∞–∫ –ø–æ–¥–∞—Ç—å')) {
    return `üìù **–ü—Ä–æ—Ü–µ—Å—Å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –≤—É–∑—ã –†–ö:**

**–®–∞–≥ 1: –ï–ù–¢ (–ï–¥–∏–Ω–æ–µ –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)**
‚Ä¢ –°—Ä–æ–∫–∏: –æ–±—ã—á–Ω–æ –∏—é–Ω—å-–∏—é–ª—å
‚Ä¢ –ü—Ä–µ–¥–º–µ—Ç—ã: 5 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö
‚Ä¢ –ú–∏–Ω–∏–º—É–º –¥–ª—è –≤—É–∑–∞: 50 –±–∞–ª–ª–æ–≤
‚Ä¢ –î–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º: 110-125+

**–®–∞–≥ 2: –°–±–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**
‚Ä¢ –ê—Ç—Ç–µ—Å—Ç–∞—Ç –æ —Å—Ä–µ–¥–Ω–µ–º –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏
‚Ä¢ –£–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏
‚Ä¢ 6 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π 3x4
‚Ä¢ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ 086—É
‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ï–ù–¢

**–®–∞–≥ 3: –ü–æ–¥–∞—á–∞ –∑–∞—è–≤–ª–µ–Ω–∏—è**
‚Ä¢ –û–Ω–ª–∞–π–Ω —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –≤—É–∑–∞
‚Ä¢ –ò–ª–∏ –ª–∏—á–Ω–æ –≤ –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏
‚Ä¢ –°—Ä–æ–∫–∏: 1 –∏—é–ª—è - 20 –∞–≤–≥—É—Å—Ç–∞

**–®–∞–≥ 4: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è**
‚Ä¢ –°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ (–¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤—É–∑–æ–≤)
‚Ä¢ –¢–≤–æ—Ä—á–µ—Å–∫–∏–µ —ç–∫–∑–∞–º–µ–Ω—ã (–¥–ª—è —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π)
‚Ä¢ –Ø–∑—ã–∫–æ–≤–æ–π —Ç–µ—Å—Ç (–¥–ª—è –∞–Ω–≥–ª–æ—è–∑—ã—á–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º)

**–®–∞–≥ 5: –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ**
‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: –æ–±—ã—á–Ω–æ 20-25 –∞–≤–≥—É—Å—Ç–∞
‚Ä¢ –û–ø–ª–∞—Ç–∞ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

–í –∫–∞–∫–æ–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ—Å—Ç—É–ø–∞—Ç—å?`
  }

  // Cities - using database
  if (lowerMessage.includes('–∞–ª–º–∞—Ç—ã') || lowerMessage.includes('–∞—Å—Ç–∞–Ω–∞') || 
      lowerMessage.includes('–≥–æ—Ä–æ–¥') || lowerMessage.includes('–∫–∞—Ä–∞–≥–∞–Ω–¥–∞')) {
    let city = null
    if (lowerMessage.includes('–∞–ª–º–∞—Ç—ã')) city = '–ê–ª–º–∞—Ç—ã'
    else if (lowerMessage.includes('–∞—Å—Ç–∞–Ω–∞')) city = '–ê—Å—Ç–∞–Ω–∞'
    else if (lowerMessage.includes('–∫–∞—Ä–∞–≥–∞–Ω–¥–∞')) city = '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞'

    if (city) {
      const cityUniversities = universities.filter(u => u.city === city)
        .sort((a, b) => b.rating - a.rating)
        .slice(0, 8)

      let response = `üìç **–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –≤ –≥–æ—Ä–æ–¥–µ ${city}:**\n\n`
      
      cityUniversities.forEach((uni, index) => {
        response += `${index + 1}. **${uni.shortName}** - ${uni.name}\n`
        response += `   ‚Ä¢ –†–µ–π—Ç–∏–Ω–≥: ${uni.rating}/5.0`
        if (uni.worldRank) response += ` (#${uni.worldRank} –≤ –º–∏—Ä–µ)`
        response += `\n`
        response += `   ‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: –æ—Ç ${(uni.tuitionRange.min / 1000000).toFixed(1)} –º–ª–Ω‚Ç∏/–≥–æ–¥\n`
        response += `   ‚Ä¢ –°—Ç—É–¥–µ–Ω—Ç–æ–≤: ${uni.students.toLocaleString()}\n`
        if (uni.achievements && uni.achievements.length > 0) {
          response += `   ‚Ä¢ ${uni.achievements[0]}\n`
        }
        response += `\n`
      })

      response += `**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ ${city === '–ê–ª–º–∞—Ç—ã' ? '–ê–ª–º–∞—Ç—ã' : city === '–ê—Å—Ç–∞–Ω–∞' ? '–ê—Å—Ç–∞–Ω—ã' : '–ö–∞—Ä–∞–≥–∞–Ω–¥—ã'}:**\n`
      if (city === '–ê–ª–º–∞—Ç—ã') {
        response += `‚úì –ö—Ä—É–ø–Ω–µ–π—à–∏–π –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä –†–ö\n`
        response += `‚úì –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤\n`
        response += `‚úì –†–∞–∑–≤–∏—Ç–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞\n`
        response += `‚úì –ë–æ–ª—å—à–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è —Å—Ç–∞–∂–∏—Ä–æ–≤–æ–∫\n`
      } else if (city === '–ê—Å—Ç–∞–Ω–∞') {
        response += `‚úì –°—Ç–æ–ª–∏—Ü–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞\n`
        response += `‚úì –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≥–æ—Ä–æ–¥\n`
        response += `‚úì –ù–æ–≤–µ–π—à–∏–µ –∫–∞–º–ø—É—Å—ã\n`
        response += `‚úì –ë–ª–∏–∑–æ—Å—Ç—å –∫ –≥–æ—Å—Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º\n`
      } else {
        response += `‚úì –ö—Ä—É–ø–Ω—ã–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä\n`
        response += `‚úì –î–æ—Å—Ç—É–ø–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è\n`
        response += `‚úì –°–∏–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n`
      }

      response += `\n–ö–∞–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?`
      return response
    }
  }

  // Tuition and costs
  if (lowerMessage.includes('—Å—Ç–æ–∏–º–æ—Å—Ç—å') || lowerMessage.includes('—Ü–µ–Ω–∞') || 
      lowerMessage.includes('—Å–∫–æ–ª—å–∫–æ') || lowerMessage.includes('–±—é–¥–∂–µ—Ç')) {
    return `üí∞ **–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è –≤ –≤—É–∑–∞—Ö –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞:**

**–ü—Ä–µ—Å—Ç–∏–∂–Ω—ã–µ —á–∞—Å—Ç–Ω—ã–µ (1.5-3.5 –º–ª–Ω‚Ç∏/–≥–æ–¥):**
‚Ä¢ KIMEP: 2.2-3.5 –º–ª–Ω‚Ç∏
‚Ä¢ AITU: 1.8-2.2 –º–ª–Ω‚Ç∏
‚Ä¢ –ö–ë–¢–£: 1.5-2.5 –º–ª–Ω‚Ç∏
‚Ä¢ –ú–£–ò–¢: 1.6-2.0 –º–ª–Ω‚Ç∏

**–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ (400-1.8 –º–ª–Ω‚Ç∏/–≥–æ–¥):**
‚Ä¢ Nazarbayev University: 8,000 USD (‚âà3.6 –º–ª–Ω‚Ç∏)
‚Ä¢ –ö–∞–∑–ù–£: 600-1800 —Ç—ã—Å‚Ç∏
‚Ä¢ –ö–≠–£: 450-900 —Ç—ã—Å‚Ç∏
‚Ä¢ –ö–∞—Ä–¢–£: 400-850 —Ç—ã—Å‚Ç∏

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:**
‚Ä¢ –û–±—â–µ–∂–∏—Ç–∏–µ: 55-180 —Ç—ã—Å‚Ç∏/–º–µ—Å
‚Ä¢ –ü–∏—Ç–∞–Ω–∏–µ: 50-80 —Ç—ã—Å‚Ç∏/–º–µ—Å
‚Ä¢ –£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã: 100-200 —Ç—ã—Å‚Ç∏/–≥–æ–¥
‚Ä¢ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: 10-15 —Ç—ã—Å‚Ç∏/–º–µ—Å

**–°–ø–æ—Å–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã:**
‚úì –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –≥—Ä–∞–Ω—Ç (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
‚úì –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏ (—Å–∫–∏–¥–∫–∏ 30-100%)
‚úì –ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏ (36-100 —Ç—ã—Å‚Ç∏/–º–µ—Å)

–ö–∞–∫–æ–π –±—é–¥–∂–µ—Ç –≤—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ?`
  }

  // Default response
  return `–ü–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å: "${message}"

–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å:

üéì **–í—ã–±–æ—Ä —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞**
"–ü–æ—Å–æ–≤–µ—Ç—É–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –¥–ª—è IT"
"–õ—É—á—à–∏–µ –±–∏–∑–Ω–µ—Å-—à–∫–æ–ª—ã"

üìç **–ü–æ –≥–æ—Ä–æ–¥–∞–º**
"–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –ê–ª–º–∞—Ç—ã"
"–í—É–∑—ã –ê—Å—Ç–∞–Ω—ã"

üí∞ **–°—Ç–æ–∏–º–æ—Å—Ç—å –∏ –≥—Ä–∞–Ω—Ç—ã**
"–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –æ–±—É—á–µ–Ω–∏–µ?"
"–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≥—Ä–∞–Ω—Ç?"

üìä **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ**
"–°—Ä–∞–≤–Ω–∏ NU –∏ AITU"

üìù **–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ**
"–ö–∞–∫ –ø–æ—Å—Ç—É–ø–∏—Ç—å –≤ –≤—É–∑?"
"–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã?"

–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å! üòä`
}

